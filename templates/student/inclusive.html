{% extends "base.html" %}
{% block title %}AI Inclusive Search{% endblock %}
{% block content %}

<section class="inclusive-page">
  <div class="inclusive-container">

    <!-- HEADER -->
    <div class="inclusive-header">
      <h1 class="inclusive-title">
        AI-–∏–Ω–∫–ª—é–∑–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π
      </h1>
      <p class="inclusive-subtitle">
        –ù–∞–π–¥–∏—Ç–µ –≤–∞–∫–∞–Ω—Å–∏–∏, —É—á–∏—Ç—ã–≤–∞—é—â–∏–µ –≤–∞—à–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
      </p>
    </div>

    <div style="margin-top:14px;">
      <a class="btn primary" href="/student/site2" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (site2.0)</a>
      <div class="muted" style="margin-top:8px;">–û—Ç–∫—Ä–æ–µ—Ç—Å—è Next.js (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é http://127.0.0.1:3000). –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é INCLUSIVE_URL.</div>
    </div>


    <!-- SEARCH BLOCK -->
    <div class="inclusive-search-block">
      <div class="inclusive-search">
        <input id="incQuery"
               class="inclusive-input"
               placeholder="–ü—Ä–æ—Ñ–µ—Å—Å–∏—è –∏–ª–∏ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ...">
        <button id="btnFind"
                class="inclusive-search-btn">
          –ù–∞–π—Ç–∏
        </button>
      </div>
    </div>

    <!-- FILTER BLOCK -->
    <div class="inclusive-filter-block">

      <div class="inclusive-filter-header">
        <h3>–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h3>
      </div>

      <div class="inclusive-icon-filters">

        <label class="icon-check">
          <input type="checkbox" id="cat_visually_impaired">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/15226/15226873.png" alt="">
          </div>
          <span>–°–ª–∞–±–æ–≤–∏–¥—è—â–∏–µ</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_hearing_impaired">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/15871/15871849.png" alt="">
          </div>
          <span>–°–ª–∞–±–æ—Å–ª—ã—à–∞—â–∏–µ</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_mobility_access">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/4395/4395338.png" alt="">
          </div>
          <span>–ú–∞–ª–æ–º–æ–±–∏–ª—å–Ω—ã–µ</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_neurodiversity_friendly">
          <div class="icon-wrapper">
            <img src="https://img.icons8.com/?size=100&id=XCHfAP4CD6oZ&format=png&color=000000" alt="">
          </div>
          <span>–ù–µ–π—Ä–æ–¥–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_junior_friendly">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/9571/9571690.png" alt="">
          </div>
          <span>–ë–µ–∑ –æ–ø—ã—Ç–∞</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_remote_possible">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/2067/2067694.png" alt="">
          </div>
          <span>–£–¥–∞–ª—ë–Ω–Ω–∞—è</span>
        </label>

        <label class="icon-check">
          <input type="checkbox" id="cat_flexible_schedule">
          <div class="icon-wrapper">
            <img src="https://cdn-icons-png.flaticon.com/128/2837/2837693.png" alt="">
          </div>
          <span>–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫</span>
        </label>

      </div>

    </div>

                <!-- LOGIC BLOCK -->
                <div class="inclusive-logic-block">

              <div class="logic-select-wrapper">
                <label>–õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</label>
                <div class="custom-select">
                  <select id="matchLogic">
                    <option value="and" selected>
                      AND ‚Äî –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
                    </option>
                    <option value="or">
                      OR ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π
                    </option>
                  </select>
                </div>
              </div>

              <label class="logic-toggle">
                <input type="checkbox" id="allRoles">
                <span class="toggle-slider"></span>
                <span class="toggle-text">
                  –ò—Å–∫–∞—Ç—å –ø–æ –≤—Å–µ–º —Ä–æ–ª—è–º (—à–∏—Ä–æ–∫–∏–π –ø–æ–∏—Å–∫)
                </span>
              </label>

            </div>

    </div>

    <!-- RESULTS -->
    <div class="inclusive-results-wrapper">
      <div id="incResults"></div>
    </div>

  </div>
</section>

<script>
const btnFind = document.getElementById("btnFind");
const incQuery = document.getElementById("incQuery");
const resultsDiv = document.getElementById("incResults");

btnFind.addEventListener("click", runInclusive);
incQuery.addEventListener("keydown", (e) => {
  if (e.key === "Enter") runInclusive();
});

function esc(str) {
  return String(str ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function renderLoading() {
  resultsDiv.innerHTML = `
    <div class="inclusive-loading">
        <div class="loader-bar">
            <div class="loader-progress" style="width:60%"></div>
        </div>
        <p>AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏...</p>
    </div>
  `;
}

function renderEmpty() {
  resultsDiv.innerHTML = `
    <div class="inclusive-empty">
        –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    </div>
  `;
}

function renderError(msg) {
  resultsDiv.innerHTML = `
    <div class="inclusive-error">
        ${esc(msg)}
    </div>
  `;
}

async function runInclusive() {

  const categories = [
    "visually_impaired",
    "hearing_impaired",
    "mobility_access",
    "neurodiversity_friendly",
    "junior_friendly",
    "remote_possible",
    "flexible_schedule"
  ];

  const required_categories = {};
  categories.forEach(cat => {
    const el = document.getElementById("cat_" + cat);
    required_categories[cat] = el ? el.checked : false;
  });

  const payload = {
    query: incQuery.value.trim(),
    required_categories,
    match_logic: document.getElementById("matchLogic").value || "and",
    all_roles: document.getElementById("allRoles").checked,
    llm_depth: 10
  };

  renderLoading();

  try {

    const response = await fetch("/student/api/inclusive/search", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await response.json();

    if (!data || data.ok !== true) {
      renderError("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
      return;
    }

    if (!Array.isArray(data.items) || data.items.length === 0) {
      renderEmpty();
      return;
    }

    const labelMap = {
      visually_impaired: "–°–ª–∞–±–æ–≤–∏–¥—è—â–∏–µ",
      hearing_impaired: "–°–ª–∞–±–æ—Å–ª—ã—à–∞—â–∏–µ",
      mobility_access: "–ú–∞–ª–æ–º–æ–±–∏–ª—å–Ω—ã–µ",
      neurodiversity_friendly: "–ù–µ–π—Ä–æ–¥–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç",
      junior_friendly: "–ë–µ–∑ –æ–ø—ã—Ç–∞",
      remote_possible: "–£–¥–∞–ª—ë–Ω–Ω–∞—è",
      flexible_schedule: "–ì–∏–±–∫–∏–π –≥—Ä–∞—Ñ–∏–∫"
    };

    resultsDiv.innerHTML = "";

    data.items.forEach((item, index) => {

      const name = esc(item.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è");
      const employer = esc(item.employer || "");
      const url = esc(item.url || "#");

      const categoryCount = Number(item.category_true_count) || 0;

      // üî• –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê
      const progressWidth = categoryCount > 0 ? 100 : 0;

      const cats = item.categories || {};

      let catBadges = "";
      Object.keys(cats).forEach(k => {
        if (cats[k]) {
          catBadges += `
            <span class="inclusive-badge">
              ${esc(labelMap[k] || k)}
            </span>
          `;
        }
      });

      if (!catBadges) {
        catBadges = `<span class="inclusive-muted">
            –ù–µ—Ç —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
          </span>`;
      }

      const isTop = index === 0 && progressWidth === 100;

      resultsDiv.innerHTML += `
        <div class="inclusive-result ${isTop ? "top-match" : ""}">

          <div class="inclusive-left">
            <div class="inclusive-header">
              <h4>${name}</h4>
              <span class="inclusive-employer">${employer}</span>
            </div>

            <div class="inclusive-badges">
              ${catBadges}
            </div>
          </div>

          <div class="inclusive-right">

            <a href="${url}" target="_blank"
               class="student-btn primary">
              –û—Ç–∫—Ä—ã—Ç—å
            </a>

            <div class="inclusive-score">
              ${progressWidth}%
            </div>

            <div class="inclusive-progress">
              <div class="inclusive-progress-fill"
                   style="width:${progressWidth}%"></div>
            </div>

            <div class="inclusive-count">
              –ü–æ–¥—Ö–æ–¥—è—â–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${categoryCount}
            </div>

          </div>

        </div>
      `;
    });

  } catch (err) {
    renderError("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message);
  }
}
</script>

{% endblock %}